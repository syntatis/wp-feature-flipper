name: Version Update

on:
  workflow_dispatch:
    inputs:
      version:
        type: choice
        description: "Select the version to update"
        required: true
        options:
          - "Stable tag"

      part:
        type: choice
        description: "Select the version part to update"
        required: true
        options:
          - minor
          - patch
          - major

jobs:
  ci:
    name: CI
    if: ${{ github.ref_name == 'main' }}
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  bump-stable-tag:
    needs: ci
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.version == 'Stable tag' }}
    name: Bump "Stable tag" Version

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "7.4"

      - name: Require PHP dependencies
        run: composer require --dev syntatis/version-cli

      - name: Install PHP dependencies
        uses: ramsey/composer-install@v3

      - name: Get current version
        id: old
        run: |
          HEADER_VERSION="$(sed -n -e '0,/^\s*\* Version:\s\+\([0-9].\+\)$/ s##\1#p' syntatis-feature-flipper.php)";
          echo "Current version: $HEADER_VERSION"
          echo "version=$HEADER_VERSION" >> $GITHUB_OUTPUT

      - name: Increment version
        id: new
        run: |
          NEW_VERSION=$(vendor/bin/version incr ${{ steps.old.outputs.version }} -p ${{ github.event.inputs.part }})
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update version in files
        run: |
          OLD_VERSION=${{ steps.old.outputs.version }}
          NEW_VERSION=${{ steps.new.outputs.version }}
          sed -i "s/Stable tag: $OLD_VERSION/Stable tag: $NEW_VERSION/" readme.txt
          sed -i "s/const PLUGIN_VERSION = '$OLD_VERSION';/const PLUGIN_VERSION = '$NEW_VERSION';/" syntatis-feature-flipper.php
          sed -i -E "s/(Version:[[:space:]]+)$OLD_VERSION/\1$NEW_VERSION/" syntatis-feature-flipper.php
          sed -i "s/\"version\": \"$OLD_VERSION\",/\"version\": \"$NEW_VERSION\",/" package.json

      - name: Verify version update
        run: |
          EXPECTED_VERSION="${{ steps.new.outputs.version }}"
          UPDATED_HEADER_VERSION="$(sed -n -e '0,/^\s*\* Version:\s\+\([0-9].\+\)$/ s##\1#p' syntatis-feature-flipper.php)"
          UPDATED_PLUGIN_VERSION="$(sed -n -e "0,/^const PLUGIN_VERSION = '\\([0-9].\\+\\)';$/ s##\\1#p" syntatis-feature-flipper.php)"
          UPDATED_README_VERSION="$(sed -n -e '0,/^Stable tag: \([0-9].\+\)$/ s##\1#p' readme.txt | tr -d '[:space:]')"

          checks=(
            "Header:$UPDATED_HEADER_VERSION"
            "Plugin:$UPDATED_PLUGIN_VERSION"
            "Readme:$UPDATED_README_VERSION"
          )

          for check in "${checks[@]}"; do
            label="${check%%:*}"
            value="${check#*:}"
            if [ "$value" != "$EXPECTED_VERSION" ]; then
              echo "Version update failed in $label. Expected $EXPECTED_VERSION, but got $value"
              exit 1
            fi
          done

          echo "Version updated successfully from ${{ steps.old.outputs.version }} to $EXPECTED_VERSION"

      - name: Rebuild NPM package.lock
        run: npm update --package-lock-only

      - name: Rebuild POT file
        run: composer make-pot

      - name: Create a Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          branch-suffix: short-commit-hash
          commit-message: "Bump \"Stable tag\" version to ${{ steps.new.outputs.version }}"
          branch: release/v${{ steps.new.outputs.version }}
          title: "Bump \"Stable tag\" version to ${{ steps.new.outputs.version }}"
          add-paths: |
            syntatis-feature-flipper.php
            readme.txt
          body: |
            This PR updates the version of the application from ${{ steps.old.outputs.version }} to ${{ steps.new.outputs.version }}.
            Please review the changes and merge if everything looks good.
          labels: |
            release
